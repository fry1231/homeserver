<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta http-equiv="Content-Security-Policy" content="default-src * data: blob: 'unsafe-inline' 'unsafe-eval' ws: wss:;">
{#    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">#}
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="cache-control" content="no-cache">

    <title>HomeServer</title>
    <script src="https://pamplin-cdn.azureedge.net/website_assets/all_local_assets/utility_2020.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootlint/1.1.0/bootlint.min.js"></script>
    <script src='https://cdn.plot.ly/plotly-2.16.1.min.js'></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;0,800;1,300;1,400;1,600;1,700;1,800&amp;display=swap" rel="stylesheet">
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.standalone.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', path='/main.css') }}">
</head>
<style>
    body {
        background-image: url({{ url_for('static', path='/images/bg.png') }});
        color: #ffffff;
    }
    p {
        color: #ffffff;
    }
    .element{
    background-color: rgba(239, 239, 239, 0.05);
    }
</style>

<script>
    let ws, wsB;
    function addEvents() {
        document.getElementById('taskBtn').addEventListener('click', addComment);

        let elementsRemove = document.querySelectorAll(".remove");
        elementsRemove.forEach(el => el.addEventListener('click', event => {
            deleteTask(event);
        }));

        let elementsChange = document.querySelectorAll(".checkbox");
        elementsChange.forEach(el => el.addEventListener('click', event => {
            changeState(event);
        }));
    }
    window.onload = function () {
        addEvents();
        {#let client_id = Date.now()#}
        {#let prefix = "";#}
        {#if (`{{ getenv("DOMAIN") }}`=="localhost")#}
        {#    prefix = "ws";#}
        {#else#}
        {#    prefix = "wss";#}
        {#ws = new WebSocket(`${prefix}://homescreen.{{ getenv("DOMAIN") }}/tasks/ws/${client_id}`);#}
        {#ws.onopen = function(event){#}
        {#    addTasks(event);#}
        {# };#}
        {#ws.onmessage = function(event){#}
        {#    addTasks(event);#}
        {# };#}
        {#wsB = new WebSocket(`${prefix}://homescreen.{{ getenv("DOMAIN") }}/buses/ws/${client_id}`);#}
        {#wsB.onmessage = function (event) {#}
        {#    addBuses(event);#}
        {# }#}
    }

    function completedTask(el){
        return `<li class="completed"><div class="form-check"><label class="form-check-label"><input id="a${el.id}" class="" type="">${el.text}<i class="input-helper"></i></label></div><i id="${el.id}" class="remove mdi mdi-close-circle-outline"</i></li>`
    }
    function uncompletedTask(el){
        return `<li><div class="form-check"><label class="form-check-label"><input id="a${el.id}" class="" type="">${el.text}<i class="input-helper"></i></label></div><i id="${el.id}" class="remove mdi mdi-close-circle-outline"></i></li>`
    }

    function addTasks(taskList){
        let htmlToAdd = "";
        let tasksArr = [];
        for (const el of taskList) {
            tasksArr.push(el);
        }
        tasksArr.sort(function (a, b) {
            return b.id - a.id;
        })
        for (let i=0; i<tasksArr.length; i++){
            let el = tasksArr[i];
            if (el.finished)
                htmlToAdd += completedTask(el);
            else
                htmlToAdd += uncompletedTask(el);
        }
        document.getElementsByClassName('todo-list')[0].innerHTML = htmlToAdd;
        addEvents();
    }

    function addComment(event) {
        console.log("addcomment");
        event.preventDefault();
        let text = document.getElementById('taskText').value;
        const data = {"text": text};
        const params = {
            headers: {"content-type": "application/json; charset=UTF-8"},
            body: JSON.stringify(data),
            method: "POST"
        };
        fetch("tasks/add", params)
            .then(res => triggerUpdateTasks());
        document.getElementById('taskText').value = "";
    }

    function deleteTask(event) {
        const task_id = event.target.id;
        const params = {
            headers: {"content-type": "application/json; charset=UTF-8"},
            method: "DELETE"
        };
        fetch("tasks/delete/"+task_id, params)
            .then(res => triggerUpdateTasks());
    }

    function changeState(event) {
        const task_id = event.target.id.replace("a", "");
        const params = {
            headers: {"content-type": "application/json; charset=UTF-8"},
            method: "PUT"
        };
        let is_finished = true;
        if (event.target.hasAttribute("checked")) {
            is_finished = false;
        }

        fetch("tasks/change_state/"+task_id+"?is_finished="+is_finished.toString(), params)
            .then(res => triggerUpdateTasks());
    }

    function triggerUpdateTasks() {
        ws.send(JSON.stringify({"command": "trigger"}))
    }

    function addBuses(data) {
        let toDefense = data['to_defense'];
        let toRER = Array.from(data['to_rer']);
        let htmlDefense = arrivalsBus(toDefense);
        let htmlRER = arrivalsBus(toRER);

        document.getElementById("arrivalsDefense").innerHTML = htmlDefense;
        document.getElementById("arrivalsRER").innerHTML = htmlRER;
    }
    function arrivalsBus(arr) {
        let html = "";
        for (let i=0; i<arr.length; i++) {
            let el = arr[i];
            let badgeClass = "";
            if (el['route'] == '259')
                badgeClass = 'badge-primary';
            else if (el['route'] == '258')
                badgeClass = 'badge-danger';
            else
                badgeClass = 'badge-secondary';

            let etd = new Date(el['etd']);
            let dateNow = new Date();
            if ((dateNow - etd) > 0)
                html += ''
            else {
                html += `
                <div class="col-1">
                    <span class="badge ${badgeClass}">${el['route']}</span>
                </div>
                <div class="col-7">
                    <p>${el['destination']}</p>
                </div>
                <div class="col-2" backupTime="${etd.toISOString()}">
                    <p>${etd.toLocaleTimeString("ru-RU")}</p>
                </div>
                <div class="col-2 timeRemaining">
                    <p></p>
                </div>
            `;
            }
        }
        return html;
    }

    function calctime() {
        Array.from(document.getElementsByClassName("timeRemaining")).forEach(function(el) {
            let dateNow = new Date();
            let etd = new Date(el.previousElementSibling.getAttribute("backupTime"));
            let rem = etd - dateNow;
            rem = Math.round(rem / 1000);
            let html = "";
            if (rem < 3600)
                if (rem < 0)
                    html += 'Missed';
                else
                    html += new Date(rem * 1000).toISOString().substring(14, 19)
            else
                html += new Date(rem * 1000).toISOString().substring(11, 16)

            el.children[0].innerHTML = html;
        });
    }

    function refreshMaster() {
        const params = {
            headers: {"content-type": "application/json; charset=UTF-8"},
            method: "GET"
        };
        fetch("/refresh", params)
            .then((response) => response.json())
            .then((data) => {
                if (data['buses']){
                    addBuses(data['buses']);
                    calctime();
                }
                if (data['tasks']){
                    addTasks(data['tasks']);
                }
            })
    }

    function refreshCalendar() {
        const params = {
            headers: {"content-type": "application/json; charset=UTF-8"},
            method: "GET"
        };
        fetch("/calendar", params)
            .then((response) => response.text())
            .then((data) => {
                document.getElementById('calendar').innerHTML = data;
            })
    }

    function refreshCharts() {
        const params = {
            headers: {"content-type": "application/json; charset=UTF-8"},
            method: "GET"
        };
        fetch("/ambiance", params)
            .then((response) => response.json())
            .then((data) => {
                console.log(data);
                let tracesTemp = [];
                let tracesRelHum = [];
                let tracesAbsHum = [];
                for (let points of data) {
                    let roomName = points['room_name'];
                    let sensorsData = points['data'];
                    let time = [];
                    let temperature = [];
                    let rel_humidity = [];
                    let abs_humidity = [];
                    for (let point of sensorsData) {
                        time.push(point['time']);
                        let temp = point['temperature'];
                        temperature.push(temp);
                        if (point['rel_humidity']) {
                            let rel_h = point['rel_humidity'];
                            rel_humidity.push(rel_h);
                            abs_humidity.push(6.112 * Math.exp(17.67 * temp / (temp + 243.5)) * rel_h * 2.1674 / (273.15 + temp));
                        }
                    }
                    tracesTemp.push({
                        x: time,
                        y: temperature,
                        mode: 'lines',
                        line: {color: 'orange'}
                    });
                    tracesRelHum.push({
                        x: time,
                        y: rel_humidity,
                        mode: 'lines',
                        line: {color: 'blue'}
                    });
                    tracesAbsHum.push({
                        x: time,
                        y: abs_humidity,
                        mode: 'lines',
                        line: {color: 'grey'}
                    });
                }
                let layoutBase = {
                    margin: {
                        t: 10,
                        l: 50,
                        b: 15,
                        r: 10
                    },
                    paper_bgcolor: "rgba(0,0,0,0)",
                    plot_bgcolor: "rgba(0,0,0,0)",
                };
                let layoutTemp = {...layoutBase, ...{
                        yaxis: {range: [0, 45], showgrid: false},
                        xaxis: {showgrid: false, showticklabels: false}
                    }
                };
                let layoutHum = {...layoutBase, ...{
                        yaxis: {range: [10, 100], showgrid: false},
                        xaxis: {showgrid: false, showticklabels: false}
                    }
                };
                let layoutAbsHum = {...layoutBase, ...{
                        yaxis: {range: [0, 25], showgrid: false},
                        xaxis: {showgrid: false}
                    }
                };
                let config = {
                    staticPlot: true,
                    showlegend: false,
                    displayModeBar: false,
                    displaylogo: false,
                }
                Plotly.newPlot('homeTemperature', tracesTemp, layoutTemp, config);
                Plotly.newPlot('homeHumidity', tracesRelHum, layoutHum, config);
                Plotly.newPlot('homeAbsHumidity', tracesAbsHum, layoutAbsHum, config);
            })
    }

    function refreshWeather() {
        document.getElementById("weather").innerHTML = `{% include 'weather.html' %}`;
        document.getElementById("weatherDetailed").innerHTML = `{% include 'weather_detailed.html' %}`;
    }

    setInterval(calctime, 1000 * 60);
    setInterval(refreshMaster, 1000 * 2);
    setInterval(refreshCalendar, 1000 * 60 * 10);
    setInterval(refreshCharts, 1000 * 60 * 5);
    setInterval(refreshWeather, 1000 * 60 * 15);
</script>

<body>
{% block content %}
{% endblock %}
</body>
</html>